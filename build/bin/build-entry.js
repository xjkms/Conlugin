/**
 * Created by xjk-mac on 2017/11/14.
 * build entry files by node
 */

const Components = require('../../components.json');
const fs = require('fs');
const path = require('path');
const endOfLine = require('os').EOL;
const upperCase = require('uppercamelcase');
const render = require('json-templater/string')

const OUTPUT_PATH = path.join(__dirname, '../../components/index.js');

const IMPORT_TEMPLATE = 'import {{name}} from \'./{{packageName}}/index.js\'';
const MAIN_TEMPLATE = `/* Automatic generated by './build/bin/build-entry.js' */

{{imports}}

const components = [
  {{install}}
];

const install = function(Vue, opts = {}) {
  /* istanbul ignore if */
  if (install.installed) return;

  components.map(component => {
    Vue.component(component.name, component);
  });
  //
  // Vue.use(Loading.directive);
  //
  // Vue.prototype.$loading = Loading.service;
  // Vue.prototype.$msgbox = MessageBox;
  // Vue.prototype.$alert = MessageBox.alert;
  // Vue.prototype.$confirm = MessageBox.confirm;
  // Vue.prototype.$prompt = MessageBox.prompt;
  // Vue.prototype.$notify = Notification;
  // Vue.prototype.$message = Message;
};

/* istanbul ignore if */
if (typeof window !== 'undefined' && window.Vue) {
  install(window.Vue);
};

module.exports = {
  version: '{{version}}',
  install,
  {{list}}
};
`;

// 获取组件名列表
const ComponentNames = Object.keys(Components);

const importTemplate = [];
const ComponentsList = [];


// 遍历组件名生成对应模板
ComponentNames.forEach(name => {

  const ComponentName = upperCase(name);

  // 生成import部分模板
  importTemplate.push(render(IMPORT_TEMPLATE, {
    name: ComponentName,
    packageName: name
  }));
  ComponentsList.push(ComponentName);
});

const context = render(MAIN_TEMPLATE, {
  version: require('../../package.json').version,
  imports: importTemplate.join(endOfLine),
  install: ComponentsList.join(',' + endOfLine),
  list: ComponentsList.join(',' + endOfLine)
});

fs.writeFileSync(OUTPUT_PATH, context);

